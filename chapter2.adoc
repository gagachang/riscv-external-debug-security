[[chapter2]]
== ISA extension Zedsec

This chapter introduces the Zedsec ISA extension, designed to enhance security by controlling external debugger access. The extension regulates how the hart responds to external debugger requests and apples protection mechanisms to enforce debug policies based on privilege levels.

=== Debuggable/traceable privilege level

image::Smsdedbg.png[The debug access control regulation]

The extension imposes restrictions on debug and trace capabilities in alignment with RISC-V privilege modes. Debuggable/traceable privilege levels are determined by sideband signals mdbgen/mtrcen and CSR fields mseccfg.sdbgen/mseccfg.strcen. In the absence of the security extension, debug requests are accommodated across all privilege levels. To improve system security, debug access is restricted to instances where the hart's privilege level is equal to or lower than the designated *debuggable privilege level*. This measure prevents unauthorized access to resources allocated to higher privilege levels by the debugger. Similarly, trace capability is limited to the *traceable privilege level*, with trace output being restricted if the hart's privilege level exceeds the *traceable privilege level*.

[options="header"]
|===========================================================
| mdbgen sigal | mseccfg.sdbgen | debuggable privilege level
| 0            | 0              | none                      
| 0            | 1              | sub-machine only          
| 1            | 0              | all
| 1            | 1              | all                       
|===========================================================

[options="header"]
|==========================================================
| mtrcen sigal | mseccfg.strcen | traceable privilege level
| 0            | 0              | none                     
| 0            | 1              | sub-machine only         
| 1            | 0              | all             
| 1            | 1              | all                      
|==========================================================

[NOTE]
The privilege level of the hart is determined by code execution, while the debug requests are validated against the privilege level generated by the hart. This process involves two actors, which may lead to a potential Time-of-Check Time-of-Use (TOCTOU) issue. To mitigate this, the implementation must ensure that the inspection and execution of debug requests occur within the same privilege level of the hart. Failure to do so could result in debug requests bypassing access controls intended for higher privilege levels.

=== Machine Security Configuration (mseccfg, at 0x747 on RV64, 0x747(low 32 bits) and 0x757(high 32 bits) on RV32) 

The regulation of supervisor/hypervisor mode debug/trace operations will be managed by the machine mode. The **sdbgen** and **strcen** fields have been added as R/W fields in mseccfg to enforce the debug/trace policies for supervisor/hypervisor mode. These fields are only R/W in machine mode.

[NOTE]
Application-level debugging is primarily accomplished through self-hostmaked debugging, allowing the management of debug policies at the operating system level. As a result, user-level debugging management is not addressed within this extension.
In scenarios where supervisor mode is bypassed and machine mode directly launches user mode code execution, the supervisor mode runtime must facilitate self-hosted debugging. Otherwise, the use of an external debugger under these circumstances could potentially result in privilege escalation.

=== Debug Control and Status (dcsr, at 0x7b0)

The hart must not automatically handle an external debugger entity possessing machine mode privilege (or surpassing machine mode privilege) without conditions. The prv and v fields in the dcsr have been enhanced to authorize privilege for debugger accesses. Upon transitioning into Debug Mode, the v and prv fields are updated to reflect the privilege level the hart was previously operating in. Memory and CSR accesses initiated by abstract commands or from the program buffer will be treated as if they are at the privilege level held in prv and v. These accesses will undergo protections of PMA, PMP, MMU, and other mechanisms, triggering traps if they violate corresponding rules. The maximum privileged level that can be configured in prv and v is determined by the **debuggable privilege level**.

The dcsr itself is always permitted to be accessed in Debug Mode. It will generate a security fault error (cmderr 6) if the external debug attempts to configure prv and v with a privilege level higher than the **debuggable privilege level**.

[NOTE]
The external debugger has the capability to write to prv and v and subsequently read back the value, thus determining the maximum debuggable privilege level.  

Additionally, the following fields in dcsr are enhanced based on their respective privilege levels. 

<TBD clarify the RW behavior in details>
[options="header"]
|============================================
| Field    | Accessiblility                          
| ebreakvs |  VS mode and above
| ebreakvu |  VU mode and above
| ebreakm  |  M mode            
| ebeaks   |  S mode            
| ebreaku  |  U mode            
| stepie   |  M mode            
| stoptime |  M mode            
| mprven   |  M mode            
| nmip     |  M mode            
|============================================

=== Debug PC (dpc, at 0x7b1) and Debug Scratch Register (dscratch0, at 0x7b2; dscratch1, at 0x7b3)

Debug PC (dpc) and Debug Scratch Register (dscratch0, dscratch1) are not restricted by prv and v fields to simplify the architecture.

=== Traps

The extension mandates that debugger accesses adhere to privilege-based access control. If such accesses violate the enforced rules, they may fail, prompting an immediate termination of access to prevent any information leakage. Simultaneously, the command error (cmderr) shall be set to 3 (exception).

When the debugger is stepping through an instruction that triggers a transition to a higher privilege level, the hart must verify against the **debuggable privilege level** before entering Debug Mode. If debugging is permitted, the hart re-enters Debug Mode after executing the instruction. Otherwise, the hart continues executing with the pending single step request until it becomes debuggable and can re-enter Debug Mode.

The trace output must be suspended when the hart transitions to a privilege level higher than the **traceable privilege level**. It should only be resumed when the hart returns to a privilege equal or less than **traceable privilege level**.


[NOTE]
In scenarios where multiple applications are debuggable, the scheduler at a higher privilege level may switch the context during single stepping. In such cases, the debugger might halt in a different application than the original one. Users of the debugger should be mindful of this possibility.


=== Triggers 

The triggers are governed by the **debuggable privilege level**. Triggers that enter Debug Mode or initiate start/stop/notify operations to the Trace Encoder will only be match or fire when the hart operates in a mode less privileged than or equally privileged as the **debuggable privilege level**. The external debugger is unable to modify triggers enabled at a higher privilege level than the **debuggable privilege level**. The extension requires that all pending triggers intending to enter Debug Mode must match or fire before any mode switch to prevent privilege escalation.

==== Trigger chain

The privilege level of the trigger chain is determined by the highest privilege level within the chain. The entire trigger chain cannot be modified if the chain privilege level exceeds the **debuggable privilege level**.

[NOTE]
This represents a balance between usability and hardware complexity. The integrity of the trigger chain set by the hart must be maintained when an external debugger intends to utilize triggers. There may be instances where the triggers are linked across different privilege levels (e.g., from supervisor mode to machine mode), while the external debugger may only have access to supervisor mode privilege. The external debugger should not alter the chain, because it could suppress or incorrectly raise breakpoint exceptions in machine mode.

==== External triggers
The output of external triggers follows the same constraints as other triggers and will not match or fire when the privilege level of the hart is higher than the **debuggable privilege level**. The sources of input external triggers (e.g., machine mode performance counter overflow, interrupts, etc.) must be protected to prevent information leakage. The tmexttrigger.intctl and tmexttrigger.select should be limited to legal values based on the **debuggable privilege level**.

==== CSR

<TBD clarify R/W behavior when privilege not suffice>

The accessibility of trigger CSRs in Debug Mode is defined as follows to fulfill security requirements without unnecessarily complicating the architecture.

[options="header"]
|===========================================================
| Always allowed in Debug Mode | Access wtih *debuggable privilege level*
| tselect(0x7a0)               | tcontrol(0x7a5)            
| tdata1(0x7a1)                | scontext(0x5a8)            
| tdata2(0x7a2)                | hcontext(0x6a8)            
| tdata3(0x7a3)                | mcontext(0x7a8)            
| tinfo(0x7a4)                 | mscontext(0x7aa)           
|===========================================================

The following fields are redefined for mcontrol, mcontrol6, icount, itrigger, etrigger and tmexttrigger (they are variants of tdata1 at 0x7a1).

[options="header"]
|============================================================================================================================================================================================================================================================================================================================================
| Field  | Description                                                                                                                                                                                                                                                                                                     | Access  | Reset 
| vs     | When set, enable this trigger for corresponding event that are taken from VS mode. The Debug Mode is prohibited to modify the trigger setting when the trigger is enabled for higher privilege than *debuggable privilege level*. This bit is hard-wired to 0 if the hart does not support virtualization mode. | WARL    | 0     
| vu     | When set, enable this trigger for corresponding event that are taken from VU mode. The Debug Mode is prohibited to modify the trigger setting when the trigger is enabled for higher privilege than *debuggable privilege level*. This bit is hard-wired to 0 if the hart does not support virtualization mode. | WARL    | 0     
| m      | When set, enable this trigger for corresponding event that are taken from M mode. The Debug Mode is prohibited to modify the trigger setting when the trigger is enabled for higher privilege than *debuggable privilege level*.                                                                                | WARL    | 0     
| s      | When set, enable this trigger for corresponding event that are taken from S mode. The Debug Mode is prohibited to modify the trigger setting when the trigger is enabled for higher privilege than *debuggable privilege level*. This bit is hard-wired to 0 if the hart does not support S mode.               | WARL    | 0     
| u      | When set, enable this trigger for corresponding event that are taken from U mode. The Debug Mode is prohibited to modify the trigger setting when the trigger is enabled for higher privilege than *debuggable privilege level*. This bit is hard-wired to 0 if the hart does not support U mode.               | WARL    | 0     
|============================================================================================================================================================================================================================================================================================================================================

The beneath fields are redefined for tmexttrigger.

|========================================================================================================================================================================================================================================================================
| Field  | Description                                                                                                                                                                                                                                 | Access  | Reset 
| intctl | This optional bit, when set, causes this trigger to fire whenever an attached interrupt controller signals a trigger. The legal value must be constrained by *debuggable privilege level* according to the setting of interrupt controller. | WARL    | 0     
| select | Selects any combination of up to 16 TM external trigger inputs that cause this trigger to fire The legal value must be constrained by *debuggable privilege level* according to trigger input type.                                         | WARL    | 0     
|========================================================================================================================================================================================================================================================================

<TBD tdata3(textra32,textra64) >
