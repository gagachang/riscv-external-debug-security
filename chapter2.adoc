[[chapter2]]
== Zedsec (ISA extension)

This chapter introduces the Zedsec ISA extension, designed to enhance security by controlling external debugger access. The extension regulates how the hart responds to external debugger requests and apples protection mechanisms to enforce debug policies based on privilege levels.

=== Debuggable/traceable privilege level

The extension imposes restrictions on debug and trace capabilities in alignment with RISC-V privilege modes. Debuggable/traceable privilege levels are determined by input ports mdbgen/mtrcen and CSR fields mseccfg.sdbgen/mseccfg.strcen. In the absence of the security extension, debug requests are accommodated across all privilege levels. To improve system security, debug access is restricted to instances where the hart's privilege level is equal to or lower than the designated *debuggable privilege level*. This measure prevents unauthorized access to resources allocated to higher privilege levels by the debugger. Similarly, trace capability is limited to the *traceable privilege level*, with trace output being restricted if the hart's privilege level exceeds the *traceable privilege level*.

image::external_debug_dm.png[title="The debug operation access control ",align="center"]


image::external_debug_trace.png[title="The trace output control ",align="center"]

.Summary of debug control knobs per privilege
[options="header"]
|===========================================================
| mdbgen input | mseccfg.sdbgen | debuggable privilege level
| 0            | 0              | none                      
| 0            | 1              | sub-machine only          
| 1            | 0              | all
| 1            | 1              | all                       
|===========================================================

.Summary of trace control knobs per privilege
[options="header"]
|==========================================================
| mtrcen input | mseccfg.strcen | traceable privilege level
| 0            | 0              | none                     
| 0            | 1              | sub-machine only         
| 1            | 0              | all             
| 1            | 1              | all                      
|==========================================================

[NOTE]
The privilege level of the hart is determined by code execution, while the debug requests are validated against the privilege level generated by the hart. This process involves two actors, which may lead to a potential Time-of-Check Time-of-Use (TOCTOU) issue. To mitigate this, the implementation must ensure that the inspection and execution of debug requests occur within the same privilege level of the hart. Failure to do so could result in debug requests bypassing access controls intended for higher privilege levels.

=== Machine Security Configuration (mseccfg, at 0x747 on RV64, 0x747(low 32 bits) and 0x757(high 32 bits) on RV32) 

[caption="Register {counter:rimage}: ", reftext="Register {rimage}"]
[title="The `sdbgen` and `strcen` fields in mseccfg on RV32"]
[id=mseccfg-edsec-32]
[wavedrom, ,svg]
....
{reg: [
  {bits:   3, name: 'defined in Smepmp'},
  {bits:   1, name: 'WPRI'},
  {bits:   1, name: 'strcen'},
  {bits:   1, name: 'sdbgen'},
  {bits:   26, name: 'WPRI'},
], config:{lanes: 2, hspace:1024}}
....
[caption="Register {counter:rimage}: ", reftext="Register {rimage}"]
[title="The `sdbgen` and `strcen` fields in mseccfg on RV64"]
[id=mseccfg-edsec-64]
[wavedrom, ,svg]
....
{reg: [
  {bits:   3, name: 'defined in Smepmp'},
  {bits:   1, name: 'WPRI'},
  {bits:   1, name: 'strcen'},
  {bits:   1, name: 'sdbgen'},
  {bits:   58, name: 'WPRI'},
], config:{lanes: 3, hspace:1024}}
....

The regulation of supervisor/hypervisor mode debug/trace operations will be managed by the machine mode. The `sdbgen` and `strcen` fields have been added as R/W fields in mseccfg to enforce the debug/trace policies for supervisor/hypervisor mode. These fields are only R/W in machine mode.

[NOTE]
Application-level debugging is primarily accomplished through self-hosted debugging, allowing the management of debug policies at the operating system level. As a result, user-level debugging management is not addressed within this extension.
In scenarios where supervisor mode is bypassed and machine mode directly launches user mode code execution, the supervisor mode runtime must facilitate self-hosted debugging. Otherwise, the use of an external debugger under these circumstances could potentially result in privilege escalation.

=== Debug Control and Status (dcsr, at 0x7b0)

The hart must not automatically handle an external debugger entity possessing machine mode privilege (or surpassing machine mode privilege) without conditions. The prv and v fields in the dcsr have been enhanced to authorize privilege for debugger accesses. Upon transitioning into Debug Mode, the v and prv fields are updated to reflect the privilege level the hart was previously operating in. The dcsr is always permitted to be accessed in Debug Mode and the fields prv and v could configured to grant privilege to the debugger other than the one when the harts transitioned to Debug Mode. The maximum privilege level that can be configured in prv and v is determined by the **debuggable privilege level**. It will generate a security fault error (cmderr 6) if the external debugger attempts to configure prv and v with a privilege higher than the **debuggable privilege level**.

Memory and CSR accesses initiated by abstract commands or from the program buffer will be treated as if they are at the privilege level held in prv and v. These accesses will undergo protections of PMA, PMP, MMU, and other mechanisms, triggering traps if they violate corresponding rules. 

[NOTE]
The external debugger has the capability to write to prv and v and subsequently read back the value, thus determining the maximum **debuggable privilege level**.  

Additionally, the fields in dcsr are further constrained based on their sphere of action. For example, when a field is effective in machine mode, it is accessible only to debugger which is granted with machine mode privilege. The detailed accessibility is listed in the following table.

.Dcsr fields accessibility against privilege granted to external debugger
[options="header"]
|============================================
| Field    | Accessible privilege                          
| ebreakvs |  VS and above
| ebreakvu |  VU and above
| ebreakm  |  M 
| ebeaks   |  S and above
| ebreaku  |  U and above
| stepie   |  M 
| stoptime |  M 
| mprven   |  M 
| nmip     |  M 
|============================================

=== Debug PC (dpc, at 0x7b1) and Debug Scratch Register (dscratch0, at 0x7b2; dscratch1, at 0x7b3)

Debug PC (dpc) and Debug Scratch Register (dscratch0, dscratch1) are not restricted by prv and v fields to simplify the architecture.

=== Traps

The extension mandates that external debugger accesses adhere to privilege-based access control. If such accesses violate the enforced rules, they may fail, prompting an immediate termination of access to prevent any information leakage. Simultaneously, the command error (cmderr) shall be set to 3 (exception).

When the external debugger is stepping through an instruction that triggers a transition to a higher privilege level, the hart must verify against the **debuggable privilege level** before entering Debug Mode. If debugging is permitted, the hart re-enters Debug Mode after executing the instruction. Otherwise, the hart continues executing with the pending single step request until it becomes debuggable and can re-enter Debug Mode.


[NOTE]
In scenarios where multiple applications are debuggable, the scheduler at a higher privilege level may switch the context during single stepping. In such cases, the debugger might halt in a different application than the original one. Users of the debugger should be mindful of this possibility.

=== Triggers 

The triggers are governed by the **debuggable privilege level**. Triggers that enter Debug Mode will only be match or fire when the hart operates in a mode less privileged than or equally privileged as the **debuggable privilege level**. The external debugger is unable to modify triggers enabled at a higher privilege level than the **debuggable privilege level**. 

The triggers that initiate start/stop/notify operations to the Trace Encoder are regulated by the *traceable privilege level*. The triggers cannot match or fire when the hart operates in a mode more privileged than *traceable privilege level*. 

The extension requires that all pending triggers intending to enter Debug Mode or initiate trace operation must match or fire before any hart mode switch to prevent privilege escalation.

==== Relaxed `dmode` accessibility
 
The `dmode` field is accessible only in Debug Mode. When this field is set, the trigger is allocated exclusively to Debug Mode, and any write access from the hart are disregarded. However, the Debug Mode exclusive trigger could potentially serve as an attack surface for unauthorized partitions where debugging is forbidden. The extension relaxes the constrain to the `dmode`, allowing it to be R/W in machine mode. 

[NOTE]
In this definition, machine mode assumes responsibility for switching the trigger context according to the debug policy enforced for the sub-machine mode. As a result, it maintains a clean trigger context for the sub-machine mode partition.

==== Trigger chain

The privilege level of the trigger chain is determined by the highest privilege level within the chain. The entire trigger chain cannot be modified if the chain privilege level exceeds the **debuggable privilege level**.

[NOTE]
This represents a balance between usability and hardware complexity. The integrity of the trigger chain set by the hart must be maintained when an external debugger intends to utilize triggers. There may be instances where the triggers are linked across different privilege levels (e.g., from supervisor mode to machine mode), while the external debugger may only have access to supervisor mode privilege. The external debugger should not alter the chain, because it could suppress or incorrectly raise breakpoint exceptions in machine mode.

==== External triggers

The output of external triggers follows the same constraints as other triggers and will not match or fire when the privilege level of the hart is higher than the **debuggable privilege level**. The sources of input external triggers (e.g., machine mode performance counter overflow, interrupts, etc.) must be protected to prevent information leakage. The tmexttrigger.intctl and tmexttrigger.select should be limited to legal values based on the **debuggable privilege level**.

==== Trigger configuration 

The extension enforces access control in Debug Mode, which inadvertently complicates trigger usage within this mode. To mitigate these complications, certain trigger CSRs, tselect, tdata1, tdata2, tdata3, and tinfo are always permitted in Debug Mode, irrespective of the privileges granted to external debuggers. However, the remaining CSRs, tcontrol, scontext, hcontext, mcontext, and mscontext continue to adhere to the debug privileges granted.

.Trigger CSR accessibility in Debug Mode
[options="header"]
|===========================================================
| Always allowed in Debug Mode | Access with granted privilege 
| tselect(0x7a0)               | tcontrol(0x7a5)            
| tdata1(0x7a1)                | scontext(0x5a8)            
| tdata2(0x7a2)                | hcontext(0x6a8)            
| tdata3(0x7a3)                | mcontext(0x7a8)            
| tinfo(0x7a4)                 | mscontext(0x7aa)           
|===========================================================


Beyond CSR-level accessibility adjustments, the fields within mcontrol, mcontrol6, icount, itrigger, etrigger, and tmexttrigger—variants of tdata1 located at 0x7a1—are redefined to limit the effective scope of triggers as follows:

.Tdata1 fields accessibility against privilege granted to external debugger
[options="header"]
|============================================
| Field    | Accessible privilege                          
| vs       |  VS and above
| vu       |  VU and above
| m        |  M 
| s        |  S and above
| u        |  U and above
|============================================

The fields `intctl` and `sselect` in tmexttrigger are regulated based on the *debuggable privilege level*, as they may be linked to resources belonging to unauthorized privilege levels. Their definitions are provided in the table below

.The redefinition of field `intctl` and `sselect` in tmexttrigger
[options="header"]
|========================================================================================================================================================================================================================================================================
| Field  | Description                                                                                                                                                                                                                                 | Access  | Reset 
| intctl | This optional bit, when set, causes this trigger to fire whenever an attached interrupt controller signals a trigger. The legal value must be constrained by *debuggable privilege level* according to the setting of interrupt controller. | WLRL    | 0     
| select | Selects any combination of up to 16 TM external trigger inputs that cause this trigger to fire The legal value must be constrained by *debuggable privilege level* according to trigger input type.                                         | WLRL    | 0     
|========================================================================================================================================================================================================================================================================

The textra32, textra64 provides additional filtering capbility for triggers. They are permitted for access in Debug Mode, as they do not affact the trigger firing/matching when triggers are supressed by *debuggable privilege level*.
