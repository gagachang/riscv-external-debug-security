[[chapter3]]
== Debug Module Security Extension (non-ISA extension)

This chapter outlines the security enhancements implemented in the Debug Module and trace function. Access by external debuggers will be restricted, and trace output will be limited when privilege levels are insufficient.

=== External debug security extension discovery 

The External Debug Security Extension imposes additional security constraints and introduces non-backward-compatible changes. The presence of the External Debug Security Extension can be determined by examining the allsecured/anysecured bits in dmstatus.

.The fields in dmstatus for external debug security extension discovery 
[options="header"]
|===============================================================================================================================================
| Field      | Bit | Description                                                                                                | Access | Reset
| allsecured | 21  | The field is 1 when all currently selected hart are secured and not running in debuggable privilege levels | R    | 0    
| anysecured | 20  | The field is 1 when any currently selected hart is secured and not running in debuggable privilege levels  | R    | 0    
|===============================================================================================================================================

=== Machine mode debug and trace control 

Access to machine mode debug/trace functionality must be granted by a trusted entity, such as the Root of Trust (RoT). A combination of input port propagating signals to hart, mdbgen and mtrcen, are introduced to manage the machine mode debug/trace policy. These signals are exclusively controlled by the RoT entity, which is responsible for booting and attesting the hart.

The mdbgen and mtrcen signals must be lockable by the RoT to prevent unauthorized modification of their values.

The sub-machine mode access control mechanisms are addressed in <<chapter2>>.

[NOTE]
If the machine mode ROM serves as the RoT, the ROM itself is responsible for managing mdbgen and mtrcen. The value of input ports could be bundled in an MMIO (Memory-Mapped I/O) outside the hart, such as in the Debug Module. Physical protections over the signals are implementation-specific and will not be discussed in this document.

=== Halt

The hart can only be halted when it is running at the **debuggable privilege level** or a less privileged level. Otherwise, the halt request will remain pending until the hart meets the aforementioned requirement. Consequently, the response to the debugger request may take longer than one second, and this constraint must be relaxed.

When machine mode is not permitted to engage in debugging, the halt-on-reset operation must fail and set cmderr to 6 (security fault error).

=== Reset

Reset operations must be safeguarded against various attacks. The RISC-V Debug Specification defines the hartreset and ndmreset operations, which reset selected harts or the entire system (excluding the Debug Module), respectively. Hartreset should be prohibited when machine mode is not authorized to engage in debugging. Ndmreset is a system-level reset not tied to hart privilege and can only be secured by the system. Thus, it should be disabled.

=== Keepalive

The keepalive operation shall only be accessible when machine mode is permitted to engage in debugging.

.Summary of permit condition for debug operations
[%autowidth]
[options="header"]
|============================================================
| Debug operations   | Permit condition                      
| abstract commands  | debuggable privilege >= hart privilege
| halt               | debuggable privilege >= hart privilege
| hartreset          | debuggable privilege == machine mode  
| resethaltreq       | debuggable privilege == machine mode  
| ndmreset           | debuggable privilege == machine mode  
| keepalive          | debuggable privilege == machine mode  
|============================================================


=== Relaxed permission checks

The field relaxedpriv in abstractcs allows for relaxed permission checks, such as bypassing PMA, PMP, MMU, etc. However, this relaxation violates security requirements, and the extension mandates that relaxedpriv be hardwired to 0x0.

=== System bus access 

System bus access enables direct reading/writing of memory space without involving the hart. However, it must always be regulated by bus initiator protection mechanisms such as IOPMP, WorldGuard, etc. If these protections are not in place, system bus access shall not be implemented. Failed system bus access attempts result in a bus security fault error (sberror 6).

[NOTE]
Trusted entities like RoT should configure IOPMP or equivalent protection before granting debug access to machine mode. Similarly, machine mode should apply this protection before enabling supervisor/hypervisor mode debug. The bus initiator protection must adhere to the debug policy enforced on the harts.

=== Security fault error

A dedicated error code, security fault error (cmderr 6), is included in abstractcs.cmderr to signal any breaches of security protection linked to hart privilege levels. Additionally, the bus security fault error (sberror 6) is introduced to denote errors related to system bus access.

=== Trace

The trace function might implement filtering feature, which can filter trace packets based on the hart privilege level. However, this filtering lacks protection by any security rules. The extension mandates that the trace output be regulated by the **traceable privilege level**. The trace output must be suspended when the hart transitions to a privilege level higher than the **traceable privilege level**. It should only be resumed when the hart returns to a privilege equal or less than **traceable privilege level**.


